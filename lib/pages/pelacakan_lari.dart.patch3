bool granted = await _checkLocationPermission();

    setState(() {
      _permissionDenied = !granted;
    });

    if (granted && _mapReady) {
      // Wait for map to be ready before moving camera
      try {
        Position pos = await Geolocator.getCurrentPosition();
        final GoogleMapController controller = await _mapController.future;
        controller.animateCamera(
          CameraUpdate.newLatLngZoom(
            LatLng(pos.latitude, pos.longitude),
            18,
          ),
        );
      } catch (e) {
        // Handle error silently
      }
    }
  }
=======
  Future<void> _checkPermissionOnStart() async {
    bool granted = await _checkLocationPermission();

    setState(() {
      _permissionDenied = !granted;
    });

    if (granted) {
      if (_mapReady) {
        // Wait for map to be ready before moving camera
        try {
          Position pos = await Geolocator.getCurrentPosition();
          final GoogleMapController controller = await _mapController.future;
          controller.animateCamera(
            CameraUpdate.newLatLngZoom(
              LatLng(pos.latitude, pos.longitude),
              18,
            ),
          );
        } catch (e) {
          // Handle error silently
        }
      }
    }
  }
>>>>>>> REPLACE

<<<<<<< SEARCH
  void _startTracking() async {
    bool hasPermission = await _checkLocationPermission();
    if (!hasPermission) {
      _showLocationDeniedDialog();
      setState(() {
        _permissionDenied = true;
      });
      return;
    }

    setState(() {
      _isTracking = true;
      _isPaused = false;
      _distance = 0.0;
      _seconds = 0;
      _route.clear();
      _lastPosition = null;
    });

    _timer?.cancel();
    _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
      setState(() {
        _seconds++;
      });
    });

    _positionStreamSubscription?.cancel();
    _positionStreamSubscription = Geolocator.getPositionStream(
      locationSettings: const LocationSettings(
        accuracy: LocationAccuracy.bestForNavigation,
        distanceFilter: 3,
      ),
    ).listen((position) async {
      LatLng currentLatLng = LatLng(position.latitude, position.longitude);

      if (_lastPosition != null) {
        double addedDistance = Geolocator.distanceBetween(
          _lastPosition!.latitude,
          _lastPosition!.longitude,
          position.latitude,
          position.longitude,
        ) / 1000.0; // meter to km
        _distance += addedDistance;
      }
      _lastPosition = position;

      if (_route.isEmpty) {
        // Add initial position immediately to start polyline from first point
        _route.add(currentLatLng);

        if (_mapReady) {
          // Animate camera immediately when starting
          final GoogleMapController controller = await _mapController.future;
          controller.animateCamera(CameraUpdate.newLatLngZoom(currentLatLng, 17));
        }
      } else {
        _route.add(currentLatLng);

        if (_mapReady) {
          final GoogleMapController controller = await _mapController.future;
          controller.animateCamera(CameraUpdate.newLatLng(currentLatLng));
        }
      }

      setState(() {});
    });
  }
=======
  void _startTracking() async {
    bool hasPermission = await _checkLocationPermission();
    if (!hasPermission) {
      _showLocationDeniedDialog();
      setState(() {
        _permissionDenied = true;
      });
      return;
    }

    setState(() {
      _isTracking = true;
      _isPaused = false;
      _distance = 0.0;
      _seconds = 0;
      _route.clear();
      _lastPosition = null;
    });

    _timer?.cancel();
    _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
      setState(() {
        _seconds++;
      });
    });

    _positionStreamSubscription?.cancel();
    _positionStreamSubscription = Geolocator.getPositionStream(
      locationSettings: const LocationSettings(
        accuracy: LocationAccuracy.bestForNavigation,
        distanceFilter: 3,
      ),
    ).listen((position) async {
      LatLng currentLatLng = LatLng(position.latitude, position.longitude);

      if (_lastPosition != null) {
        double addedDistance = Geolocator.distanceBetween(
          _lastPosition!.latitude,
          _lastPosition!.longitude,
          position.latitude,
          position.longitude,
        ) / 1000.0; // meter to km
        _distance += addedDistance;
      }
      _lastPosition = position;

      if (_route.isEmpty) {
        // Add initial position immediately to start polyline from first point
        _route.add(currentLatLng);

        if (_mapReady) {
          // Animate camera immediately when starting
          final GoogleMapController controller = await _mapController.future;
          controller.animateCamera(CameraUpdate.newLatLngZoom(currentLatLng, 17));
        }
      } else {
        _route.add(currentLatLng);

        if (_mapReady) {
          final GoogleMapController controller = await _mapController.future;
          controller.animateCamera(CameraUpdate.newLatLng(currentLatLng));
        }
      }

      setState(() {});
    });
  }
